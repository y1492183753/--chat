{"remainingRequest":"D:\\im-ui\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\im-ui\\src\\components\\chat\\ChatHistory.vue?vue&type=script&lang=js","dependencies":[{"path":"D:\\im-ui\\src\\components\\chat\\ChatHistory.vue","mtime":1703809562000},{"path":"D:\\im-ui\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1710142170000},{"path":"D:\\im-ui\\node_modules\\babel-loader\\lib\\index.js","mtime":1710142166000},{"path":"D:\\im-ui\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1710142170000},{"path":"D:\\im-ui\\node_modules\\vue-loader\\lib\\index.js","mtime":1710142168000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CglpbXBvcnQgQ2hhdE1lc3NhZ2VJdGVtIGZyb20gJy4vQ2hhdE1lc3NhZ2VJdGVtLnZ1ZSc7CgoJZXhwb3J0IGRlZmF1bHQgewoJCW5hbWU6ICdjaGF0SGlzdG9yeScsCgkJY29tcG9uZW50czogewoJCQlDaGF0TWVzc2FnZUl0ZW0KCQl9LAoJCXByb3BzOiB7CgkJCXZpc2libGU6IHsKCQkJCXR5cGU6IEJvb2xlYW4KCQkJfSwKCQkJY2hhdDogewoJCQkJdHlwZTogT2JqZWN0CgkJCX0sCgkJCWZyaWVuZDogewoJCQkJdHlwZTogT2JqZWN0CgkJCX0sCgkJCWdyb3VwOiB7CgkJCQl0eXBlOiBPYmplY3QKCQkJfSwKCQkJZ3JvdXBNZW1iZXJzOiB7CgkJCQl0eXBlOiBBcnJheSwKCQkJfQoJCX0sCgkJZGF0YSgpIHsKCQkJcmV0dXJuIHsKCQkJCXBhZ2U6IDEsCgkJCQlzaXplOiAxMCwKCQkJCW1lc3NhZ2VzOiBbXSwKCQkJCWxvYWRBbGw6IGZhbHNlLAoJCQkJbG9hZGluZzogZmFsc2UsCgkJCQlsYXN0U2Nyb2xsVGltZTogbmV3IERhdGUoKQoJCQl9CgkJfSwKCQltZXRob2RzOiB7CgkJCW9uQ2xvc2UoKSB7CgkJCQl0aGlzLnBhZ2UgPSAxOwoJCQkJdGhpcy5tZXNzYWdlcyA9IFtdOwoJCQkJdGhpcy5sb2FkQWxsID0gZmFsc2U7CgkJCQl0aGlzLiRlbWl0KCdjbG9zZScpOwoJCQl9LAoJCQlvblNjcm9sbCgpIHsKCQkJCWxldCBoaWdoID0gdGhpcy4kcmVmcy5zY3JvbGxiYXIuJHJlZnMud3JhcC5zY3JvbGxUb3A7IC8v6Led56a76aG26YOo55qE6Led56a7CgkJCQlsZXQgdGltZURpZmYgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMubGFzdFNjcm9sbFRpbWUuZ2V0VGltZSgpOwoJCQkJaWYgKCBoaWdoIDwgMzAgJiYgdGltZURpZmY+NTAwKSB7CgkJCQkJdGhpcy5sYXN0U2Nyb2xsVGltZSA9IG5ldyBEYXRlKCk7CgkJCQkJdGhpcy5sb2FkTWVzc2FnZXMoKTsKCQkJCQkKCQkJCX0KCQkJfSwKCQkJbG9hZE1lc3NhZ2VzKCkgewoJCQkJaWYodGhpcy5sb2FkQWxsKXsKCQkJCQlyZXR1cm4gdGhpcy4kbWVzc2FnZS5zdWNjZXNzKCLlt7LliLDovr7pobbpg6giKTsKCQkJCX0KCQkJCWxldCBwYXJhbSA9IHsKCQkJCQlwYWdlOiB0aGlzLnBhZ2UrKywKCQkJCQlzaXplOiB0aGlzLnNpemUKCQkJCX0KCQkJCWlmICh0aGlzLmNoYXQudHlwZSA9PSAnR1JPVVAnKSB7CgkJCQkJcGFyYW0uZ3JvdXBJZCA9IHRoaXMuZ3JvdXAuaWQ7CgkJCQl9IGVsc2UgewoJCQkJCXBhcmFtLmZyaWVuZElkID0gdGhpcy5mcmllbmQuaWQ7CgkJCQl9CgkJCQl0aGlzLmxvYWRpbmcgPSB0cnVlOwoJCQkJdGhpcy4kaHR0cCh7CgkJCQkJdXJsOiB0aGlzLmhpc3Ryb3lBY3Rpb24sCgkJCQkJbWV0aG9kOiAnZ2V0JywKCQkJCQlwYXJhbXM6IHBhcmFtCgkJCQl9KS50aGVuKG1lc3NhZ2VzID0+IHsKCQkJCQltZXNzYWdlcy5mb3JFYWNoKG0gPT4gdGhpcy5tZXNzYWdlcy51bnNoaWZ0KG0pKTsKCQkJCQl0aGlzLmxvYWRpbmcgPSBmYWxzZTsKCQkJCQlpZihtZXNzYWdlcy5sZW5ndGggPHRoaXMuc2l6ZSl7CgkJCQkJCXRoaXMubG9hZEFsbCA9IHRydWU7CgkJCQkJfQoJCQkJCXRoaXMucmVmcmVzaFNjcm9sbFBvcygpOwoJCQkJfSkuY2F0Y2goKCk9PnsKCQkJCQl0aGlzLmxvYWRpbmcgPSBmYWxzZTsKCQkJCX0pCgkJCX0sCgkJCXNob3dOYW1lKG1zZ0luZm8pIHsKCQkJCWlmICh0aGlzLmNoYXQudHlwZSA9PSAnR1JPVVAnKSB7CgkJCQkJbGV0IG1lbWJlciA9IHRoaXMuZ3JvdXBNZW1iZXJzLmZpbmQoKG0pID0+IG0udXNlcklkID09IG1zZ0luZm8uc2VuZElkKTsKCQkJCQlyZXR1cm4gbWVtYmVyID8gbWVtYmVyLmFsaWFzTmFtZSA6ICIiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gbXNnSW5mby5zZW5kSWQgPT0gdGhpcy5taW5lLmlkID8gdGhpcy5taW5lLm5pY2tOYW1lIDogdGhpcy5jaGF0LnNob3dOYW1lCgkJCQl9CgkJCX0sCgkJCWhlYWRJbWFnZShtc2dJbmZvKSB7CgkJCQlpZiAodGhpcy5jaGF0LnR5cGUgPT0gJ0dST1VQJykgewoJCQkJCWxldCBtZW1iZXIgPSB0aGlzLmdyb3VwTWVtYmVycy5maW5kKChtKSA9PiBtLnVzZXJJZCA9PSBtc2dJbmZvLnNlbmRJZCk7CgkJCQkJcmV0dXJuIG1lbWJlciA/IG1lbWJlci5oZWFkSW1hZ2UgOiAiIjsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIG1zZ0luZm8uc2VuZElkID09IHRoaXMubWluZS5pZCA/IHRoaXMubWluZS5oZWFkSW1hZ2VUaHVtYiA6IHRoaXMuY2hhdC5oZWFkSW1hZ2UKCQkJCX0KCQkJfSwKCQkJcmVmcmVzaFNjcm9sbFBvcygpewoJCQkJbGV0IHNjcm9sbFdyYXAgPSAgdGhpcy4kcmVmcy5zY3JvbGxiYXIuJHJlZnMud3JhcDsKCQkJCWxldCBzY3JvbGxIZWlnaHQgPSBzY3JvbGxXcmFwLnNjcm9sbEhlaWdodDsKCQkJCWxldCBzY3JvbGxUb3AgPSBzY3JvbGxXcmFwLnNjcm9sbFRvcDsKCQkJCXRoaXMuJG5leHRUaWNrKCgpID0+IHsKCQkJCQlsZXQgb2Zmc2V0VG9wID0gc2Nyb2xsV3JhcC5zY3JvbGxIZWlnaHQgLSBzY3JvbGxIZWlnaHQ7CgkJCQkJc2Nyb2xsV3JhcC5zY3JvbGxUb3AgPSBzY3JvbGxUb3AgKyBvZmZzZXRUb3A7CgkJCQkJLy8g5rua5Yqo5p2h5rKh5Ye65p2l77yM57un57ut5Yqg6L29CgkJCQkJaWYoc2Nyb2xsV3JhcC5zY3JvbGxIZWlnaHQgPT0gc2Nyb2xsSGVpZ2h0KXsKCQkJCQkJdGhpcy5sb2FkTWVzc2FnZXMoKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0sCgkJY29tcHV0ZWQ6IHsKCQkJbWluZSgpIHsKCQkJCXJldHVybiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyU3RvcmUudXNlckluZm87CgkJCX0sCgkJCWhpc3Ryb3lBY3Rpb24oKSB7CgkJCQlyZXR1cm4gYC9tZXNzYWdlLyR7dGhpcy5jaGF0LnR5cGUudG9Mb3dlckNhc2UoKX0vaGlzdG9yeWA7CgkJCX0KCQl9LAoJCXdhdGNoOiB7CgkJCXZpc2libGU6IHsKCQkJCWhhbmRsZXIobmV3VmFsdWUsIG9sZFZhbHVlKSB7CgkJCQkJaWYgKG5ld1ZhbHVlKSB7CgkJCQkJCXRoaXMubG9hZE1lc3NhZ2VzKCk7CgkJCQkJCXRoaXMuJG5leHRUaWNrKCgpID0+IHsKCQkJCQkJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaXN0b3J5U2Nyb2xsYmFyJykuYWRkRXZlbnRMaXN0ZW5lcigibW91c2V3aGVlbCIsIHRoaXMub25TY3JvbGwsdHJ1ZSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0K"},{"version":3,"sources":["ChatHistory.vue"],"names":[],"mappings":";AAkBA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"ChatHistory.vue","sourceRoot":"src/components/chat","sourcesContent":["<template>\n\t<el-drawer title=\"聊天历史记录\" size=\"700px\"  :visible.sync=\"visible\" direction=\"rtl\" :before-close=\"onClose\">\n\t\t<div class=\"chat-history\" v-loading=\"loading\" \n\t\t element-loading-text=\"拼命加载中\">\n\t\t\t<el-scrollbar  class=\"chat-history-scrollbar\" ref=\"scrollbar\" id=\"historyScrollbar\" >\n\t\t\t\t<ul>\n\t\t\t\t\t<li v-for=\"(msgInfo,idx) in messages\" :key=\"idx\">\n\t\t\t\t\t\t<chat-message-item :mode=\"2\" :mine=\"msgInfo.sendId == mine.id\" :headImage=\"headImage(msgInfo)\" :showName=\"showName(msgInfo)\"\n\t\t\t\t\t\t :msgInfo=\"msgInfo\" :menu=\"false\">\n\t\t\t\t\t\t</chat-message-item>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</el-scrollbar>\n\t\t</div>\n\t</el-drawer>\n</template>\n\n<script>\n\timport ChatMessageItem from './ChatMessageItem.vue';\n\n\texport default {\n\t\tname: 'chatHistory',\n\t\tcomponents: {\n\t\t\tChatMessageItem\n\t\t},\n\t\tprops: {\n\t\t\tvisible: {\n\t\t\t\ttype: Boolean\n\t\t\t},\n\t\t\tchat: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tfriend: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tgroup: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tgroupMembers: {\n\t\t\t\ttype: Array,\n\t\t\t}\n\t\t},\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\tpage: 1,\n\t\t\t\tsize: 10,\n\t\t\t\tmessages: [],\n\t\t\t\tloadAll: false,\n\t\t\t\tloading: false,\n\t\t\t\tlastScrollTime: new Date()\n\t\t\t}\n\t\t},\n\t\tmethods: {\n\t\t\tonClose() {\n\t\t\t\tthis.page = 1;\n\t\t\t\tthis.messages = [];\n\t\t\t\tthis.loadAll = false;\n\t\t\t\tthis.$emit('close');\n\t\t\t},\n\t\t\tonScroll() {\n\t\t\t\tlet high = this.$refs.scrollbar.$refs.wrap.scrollTop; //距离顶部的距离\n\t\t\t\tlet timeDiff = new Date().getTime() - this.lastScrollTime.getTime();\n\t\t\t\tif ( high < 30 && timeDiff>500) {\n\t\t\t\t\tthis.lastScrollTime = new Date();\n\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t},\n\t\t\tloadMessages() {\n\t\t\t\tif(this.loadAll){\n\t\t\t\t\treturn this.$message.success(\"已到达顶部\");\n\t\t\t\t}\n\t\t\t\tlet param = {\n\t\t\t\t\tpage: this.page++,\n\t\t\t\t\tsize: this.size\n\t\t\t\t}\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tparam.groupId = this.group.id;\n\t\t\t\t} else {\n\t\t\t\t\tparam.friendId = this.friend.id;\n\t\t\t\t}\n\t\t\t\tthis.loading = true;\n\t\t\t\tthis.$http({\n\t\t\t\t\turl: this.histroyAction,\n\t\t\t\t\tmethod: 'get',\n\t\t\t\t\tparams: param\n\t\t\t\t}).then(messages => {\n\t\t\t\t\tmessages.forEach(m => this.messages.unshift(m));\n\t\t\t\t\tthis.loading = false;\n\t\t\t\t\tif(messages.length <this.size){\n\t\t\t\t\t\tthis.loadAll = true;\n\t\t\t\t\t}\n\t\t\t\t\tthis.refreshScrollPos();\n\t\t\t\t}).catch(()=>{\n\t\t\t\t\tthis.loading = false;\n\t\t\t\t})\n\t\t\t},\n\t\t\tshowName(msgInfo) {\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tlet member = this.groupMembers.find((m) => m.userId == msgInfo.sendId);\n\t\t\t\t\treturn member ? member.aliasName : \"\";\n\t\t\t\t} else {\n\t\t\t\t\treturn msgInfo.sendId == this.mine.id ? this.mine.nickName : this.chat.showName\n\t\t\t\t}\n\t\t\t},\n\t\t\theadImage(msgInfo) {\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tlet member = this.groupMembers.find((m) => m.userId == msgInfo.sendId);\n\t\t\t\t\treturn member ? member.headImage : \"\";\n\t\t\t\t} else {\n\t\t\t\t\treturn msgInfo.sendId == this.mine.id ? this.mine.headImageThumb : this.chat.headImage\n\t\t\t\t}\n\t\t\t},\n\t\t\trefreshScrollPos(){\n\t\t\t\tlet scrollWrap =  this.$refs.scrollbar.$refs.wrap;\n\t\t\t\tlet scrollHeight = scrollWrap.scrollHeight;\n\t\t\t\tlet scrollTop = scrollWrap.scrollTop;\n\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\tlet offsetTop = scrollWrap.scrollHeight - scrollHeight;\n\t\t\t\t\tscrollWrap.scrollTop = scrollTop + offsetTop;\n\t\t\t\t\t// 滚动条没出来，继续加载\n\t\t\t\t\tif(scrollWrap.scrollHeight == scrollHeight){\n\t\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\tcomputed: {\n\t\t\tmine() {\n\t\t\t\treturn this.$store.state.userStore.userInfo;\n\t\t\t},\n\t\t\thistroyAction() {\n\t\t\t\treturn `/message/${this.chat.type.toLowerCase()}/history`;\n\t\t\t}\n\t\t},\n\t\twatch: {\n\t\t\tvisible: {\n\t\t\t\thandler(newValue, oldValue) {\n\t\t\t\t\tif (newValue) {\n\t\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\t\tdocument.getElementById('historyScrollbar').addEventListener(\"mousewheel\", this.onScroll,true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\">\n\t.chat-history {\n\t\tdisplay: flex;\n\t\theight: 100%;\n\t\t\n\t\t.chat-history-scrollbar {\n\t\t\tflex: 1;\n\t\t\t.el-scrollbar__thumb {\n\t\t\t    background-color: #555555;\n\t\t\t}\n\t\t\tul {\n\t\t\t\tpadding: 20px;\n\n\t\t\t\tli {\n\t\t\t\t\tlist-style-type: none;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</style>\n"]}]}