{"remainingRequest":"D:\\im-ui\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\im-ui\\src\\components\\chat\\ChatHistory.vue?vue&type=style&index=0&id=04d4b355&lang=scss","dependencies":[{"path":"D:\\im-ui\\src\\components\\chat\\ChatHistory.vue","mtime":1703809562000},{"path":"D:\\im-ui\\node_modules\\css-loader\\dist\\cjs.js","mtime":1710142168000},{"path":"D:\\im-ui\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1710142170000},{"path":"D:\\im-ui\\node_modules\\postcss-loader\\src\\index.js","mtime":1710142168000},{"path":"D:\\im-ui\\node_modules\\sass-loader\\dist\\cjs.js","mtime":1710142170000},{"path":"D:\\im-ui\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1710142170000},{"path":"D:\\im-ui\\node_modules\\vue-loader\\lib\\index.js","mtime":1710142168000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ci5jaGF0LWhpc3RvcnkgewoJZGlzcGxheTogZmxleDsKCWhlaWdodDogMTAwJTsKCQoJLmNoYXQtaGlzdG9yeS1zY3JvbGxiYXIgewoJCWZsZXg6IDE7CgkJLmVsLXNjcm9sbGJhcl9fdGh1bWIgewoJCSAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjNTU1NTU1OwoJCX0KCQl1bCB7CgkJCXBhZGRpbmc6IDIwcHg7CgoJCQlsaSB7CgkJCQlsaXN0LXN0eWxlLXR5cGU6IG5vbmU7CgkJCX0KCQl9Cgl9Cn0K"},{"version":3,"sources":["ChatHistory.vue"],"names":[],"mappings":";AA2KA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA","file":"ChatHistory.vue","sourceRoot":"src/components/chat","sourcesContent":["<template>\n\t<el-drawer title=\"聊天历史记录\" size=\"700px\"  :visible.sync=\"visible\" direction=\"rtl\" :before-close=\"onClose\">\n\t\t<div class=\"chat-history\" v-loading=\"loading\" \n\t\t element-loading-text=\"拼命加载中\">\n\t\t\t<el-scrollbar  class=\"chat-history-scrollbar\" ref=\"scrollbar\" id=\"historyScrollbar\" >\n\t\t\t\t<ul>\n\t\t\t\t\t<li v-for=\"(msgInfo,idx) in messages\" :key=\"idx\">\n\t\t\t\t\t\t<chat-message-item :mode=\"2\" :mine=\"msgInfo.sendId == mine.id\" :headImage=\"headImage(msgInfo)\" :showName=\"showName(msgInfo)\"\n\t\t\t\t\t\t :msgInfo=\"msgInfo\" :menu=\"false\">\n\t\t\t\t\t\t</chat-message-item>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</el-scrollbar>\n\t\t</div>\n\t</el-drawer>\n</template>\n\n<script>\n\timport ChatMessageItem from './ChatMessageItem.vue';\n\n\texport default {\n\t\tname: 'chatHistory',\n\t\tcomponents: {\n\t\t\tChatMessageItem\n\t\t},\n\t\tprops: {\n\t\t\tvisible: {\n\t\t\t\ttype: Boolean\n\t\t\t},\n\t\t\tchat: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tfriend: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tgroup: {\n\t\t\t\ttype: Object\n\t\t\t},\n\t\t\tgroupMembers: {\n\t\t\t\ttype: Array,\n\t\t\t}\n\t\t},\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\tpage: 1,\n\t\t\t\tsize: 10,\n\t\t\t\tmessages: [],\n\t\t\t\tloadAll: false,\n\t\t\t\tloading: false,\n\t\t\t\tlastScrollTime: new Date()\n\t\t\t}\n\t\t},\n\t\tmethods: {\n\t\t\tonClose() {\n\t\t\t\tthis.page = 1;\n\t\t\t\tthis.messages = [];\n\t\t\t\tthis.loadAll = false;\n\t\t\t\tthis.$emit('close');\n\t\t\t},\n\t\t\tonScroll() {\n\t\t\t\tlet high = this.$refs.scrollbar.$refs.wrap.scrollTop; //距离顶部的距离\n\t\t\t\tlet timeDiff = new Date().getTime() - this.lastScrollTime.getTime();\n\t\t\t\tif ( high < 30 && timeDiff>500) {\n\t\t\t\t\tthis.lastScrollTime = new Date();\n\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t},\n\t\t\tloadMessages() {\n\t\t\t\tif(this.loadAll){\n\t\t\t\t\treturn this.$message.success(\"已到达顶部\");\n\t\t\t\t}\n\t\t\t\tlet param = {\n\t\t\t\t\tpage: this.page++,\n\t\t\t\t\tsize: this.size\n\t\t\t\t}\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tparam.groupId = this.group.id;\n\t\t\t\t} else {\n\t\t\t\t\tparam.friendId = this.friend.id;\n\t\t\t\t}\n\t\t\t\tthis.loading = true;\n\t\t\t\tthis.$http({\n\t\t\t\t\turl: this.histroyAction,\n\t\t\t\t\tmethod: 'get',\n\t\t\t\t\tparams: param\n\t\t\t\t}).then(messages => {\n\t\t\t\t\tmessages.forEach(m => this.messages.unshift(m));\n\t\t\t\t\tthis.loading = false;\n\t\t\t\t\tif(messages.length <this.size){\n\t\t\t\t\t\tthis.loadAll = true;\n\t\t\t\t\t}\n\t\t\t\t\tthis.refreshScrollPos();\n\t\t\t\t}).catch(()=>{\n\t\t\t\t\tthis.loading = false;\n\t\t\t\t})\n\t\t\t},\n\t\t\tshowName(msgInfo) {\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tlet member = this.groupMembers.find((m) => m.userId == msgInfo.sendId);\n\t\t\t\t\treturn member ? member.aliasName : \"\";\n\t\t\t\t} else {\n\t\t\t\t\treturn msgInfo.sendId == this.mine.id ? this.mine.nickName : this.chat.showName\n\t\t\t\t}\n\t\t\t},\n\t\t\theadImage(msgInfo) {\n\t\t\t\tif (this.chat.type == 'GROUP') {\n\t\t\t\t\tlet member = this.groupMembers.find((m) => m.userId == msgInfo.sendId);\n\t\t\t\t\treturn member ? member.headImage : \"\";\n\t\t\t\t} else {\n\t\t\t\t\treturn msgInfo.sendId == this.mine.id ? this.mine.headImageThumb : this.chat.headImage\n\t\t\t\t}\n\t\t\t},\n\t\t\trefreshScrollPos(){\n\t\t\t\tlet scrollWrap =  this.$refs.scrollbar.$refs.wrap;\n\t\t\t\tlet scrollHeight = scrollWrap.scrollHeight;\n\t\t\t\tlet scrollTop = scrollWrap.scrollTop;\n\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\tlet offsetTop = scrollWrap.scrollHeight - scrollHeight;\n\t\t\t\t\tscrollWrap.scrollTop = scrollTop + offsetTop;\n\t\t\t\t\t// 滚动条没出来，继续加载\n\t\t\t\t\tif(scrollWrap.scrollHeight == scrollHeight){\n\t\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\tcomputed: {\n\t\t\tmine() {\n\t\t\t\treturn this.$store.state.userStore.userInfo;\n\t\t\t},\n\t\t\thistroyAction() {\n\t\t\t\treturn `/message/${this.chat.type.toLowerCase()}/history`;\n\t\t\t}\n\t\t},\n\t\twatch: {\n\t\t\tvisible: {\n\t\t\t\thandler(newValue, oldValue) {\n\t\t\t\t\tif (newValue) {\n\t\t\t\t\t\tthis.loadMessages();\n\t\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\t\tdocument.getElementById('historyScrollbar').addEventListener(\"mousewheel\", this.onScroll,true);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\">\n\t.chat-history {\n\t\tdisplay: flex;\n\t\theight: 100%;\n\t\t\n\t\t.chat-history-scrollbar {\n\t\t\tflex: 1;\n\t\t\t.el-scrollbar__thumb {\n\t\t\t    background-color: #555555;\n\t\t\t}\n\t\t\tul {\n\t\t\t\tpadding: 20px;\n\n\t\t\t\tli {\n\t\t\t\t\tlist-style-type: none;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</style>\n"]}]}